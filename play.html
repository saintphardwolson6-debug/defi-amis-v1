<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DÃ©fi Amis â€” Jouer</title>
<link rel="stylesheet" href="style.css" />
</head>
<body class="bg">
<main class="card fade-in">
  <h2 id="title"></h2>
  <p class="muted" id="subtitle"></p>

  <div id="playerBox">
    <input id="playerName" type="text" placeholder="Ton prÃ©nom..." />
    <button id="btnStart" class="btn primary">Commencer le dÃ©fi</button>
  </div>

  <form id="quizForm" class="hidden">
    <div id="questions"></div>
    <button id="btnSubmit" type="button" class="btn">Voir mon rÃ©sultat</button>
  </form>

  <div id="resultBox" class="hidden created"></div>

  <div id="leader" class="leaderboard-box hidden">
    <h3 id="leaderTitle"></h3>
    <ol id="leaderList" class="leaderboard"></ol>
  </div>
</main>

<canvas id="confetti" class="confetti hidden"></canvas>

<script>
function $(id){return document.getElementById(id);}
const params=new URLSearchParams(location.search);
const uid=params.get('uid'); if(!uid){alert('UID manquant');location.href='index.html';}
const key=`room_${uid}`;
let room=JSON.parse(localStorage.getItem(key)||'{}');
if(!room.answers){alert("DÃ©fi introuvable â˜¹ï¸");location.href='index.html';}

$('title').textContent=`DÃ©fi de ${room.host}`;
$('subtitle').textContent=`RÃ©ponds aux questions sur ${room.host}`;

const QUESTIONS=[
  "Quel est son plat prÃ©fÃ©rÃ© ?",
  "Quel est son sport prÃ©fÃ©rÃ© ?",
  "Quel est son animal prÃ©fÃ©rÃ© ?",
  "Quelle est sa couleur prÃ©fÃ©rÃ©e ?",
  "Quel est son rÃªve le plus fou ?"
];

// dÃ©marre le quiz
$('btnStart').addEventListener('click',()=>{
  const name=$('playerName').value.trim(); if(!name){alert('Entre ton prÃ©nom');return;}
  localStorage.setItem('lastPlayerName',name);
  $('playerBox').classList.add('hidden');
  $('quizForm').classList.remove('hidden');
  QUESTIONS.forEach((q,i)=>{
    const div=document.createElement('div');
    div.className='question';
    div.innerHTML=`<label>${i+1}. ${q}</label><input id="a${i}" type="text" placeholder="Ta rÃ©ponse...">`;
    $('questions').appendChild(div);
  });
});

// soumÃ¨t repons yo
$('btnSubmit').addEventListener('click',()=>{
  const name=localStorage.getItem('lastPlayerName')||'InvitÃ©';
  const guestAnswers=[]; let score=0;
  room.answers.forEach((ans,i)=>{
    const rep=($(`a${i}`).value||'').trim(); guestAnswers.push(rep);
    if(rep.toLowerCase()===ans.toLowerCase()) score++;
  });
  room.players=room.players||[];
  room.players.push({name,score,playedAt:new Date().toISOString()});
  localStorage.setItem(key,JSON.stringify(room));
  showResult(name,score);
  renderLeader();
});

function showResult(name,score){
  $('quizForm').classList.add('hidden');
  $('resultBox').classList.remove('hidden');
  $('resultBox').innerHTML=`
    <h3>Bravo ${name} ðŸŽ‰</h3>
    <p>Tu as obtenu <strong>${score}</strong> / ${room.answers.length}</p>
    <div class="row">
      <button class="btn primary" onclick="location.href='index.html'">CrÃ©er mon propre dÃ©fi</button>
    </div>`;
  burstConfetti();
}

// rendu classement
function renderLeader(){
  $('leader').classList.remove('hidden');
  $('leaderTitle').textContent=`Les amis de ${room.host}`;
  const list=room.players||[]; list.sort((a,b)=>b.score-a.score);
  $('leaderList').innerHTML='';
  list.forEach(p=>{
    const li=document.createElement('li');
    li.innerHTML=`${p.name} â€” ${p.score}/${room.answers.length}`;
    $('leaderList').appendChild(li);
  });
}

setInterval(()=>{room=JSON.parse(localStorage.getItem(key)||'{}');renderLeader();},2000);

// konfeti
function burstConfetti(){
  const c=$('confetti');c.classList.remove('hidden');c.width=innerWidth;c.height=innerHeight;
  const ctx=c.getContext('2d');const parts=[];
  for(let i=0;i<120;i++)parts.push({x:Math.random()*c.width,y:-10,vx:(Math.random()-0.5)*4,vy:Math.random()*4+2,r:Math.random()*6+3,color:['#ff4d7e','#ffd166','#06d6a0','#8ec5ff'][Math.floor(Math.random()*4)]});
  let t=0;function frame(){ctx.clearRect(0,0,c.width,c.height);parts.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.05;ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();});t++;if(t<200)requestAnimationFrame(frame);else c.classList.add('hidden');}
  frame();
}
</script>
</body>
</html>