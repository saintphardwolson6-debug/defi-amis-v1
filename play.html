<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>D√©fi Amis ‚Äî Jouer</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg">
  <main class="card">
    <div class="top">
      <button class="back" onclick="location.href='index.html'">‚Üê Accueil</button>
      <div></div>
    </div>

    <h2 id="roomTitle">D√©fi</h2>
    <p class="muted" id="roomInfo"></p>

    <div id="joinBox">
      <label>Ton nom</label>
      <input id="playerName" type="text" placeholder="Ton pr√©nom..." />
      <button id="joinBtn" class="btn primary">Rejoindre la salle</button>
    </div>

    <div id="waitBox" class="hidden">
      <p class="muted">En attente que l'h√¥te lance le jeu...</p>
      <div class="small muted">La page se mettra √† jour automatiquement.</div>
    </div>

    <form id="quizForm" class="hidden">
      <div id="questions"></div>
      <div class="row"><button type="button" id="submitAnswers" class="btn">Terminer et voir r√©sultat</button></div>
    </form>

    <div id="resultBox" class="hidden card created"></div>
  </main>

<script>
  function $(id){return document.getElementById(id);}
  const params = new URLSearchParams(location.search);
  const uid = params.get('uid');
  if(!uid){ alert('UID manquant'); location.href='index.html'; }
  const key = `room_${uid}`;
  let room = JSON.parse(localStorage.getItem(key) || '{}');
  if(!room || !room.answers){ alert('Salle introuvable ou h√¥te n\'a pas fini de configurer.'); location.href='index.html'; }

  $('roomTitle').textContent = `D√©fi de ${room.host || 'H√¥te'}`;
  $('roomInfo').textContent = `UID: ${uid} ‚Ä¢ Questions: ${room.answers.length}`;

  // elements
  const joinBox = $('joinBox'), waitBox = $('waitBox'), quizForm = $('quizForm'), questionsWrap = $('questions'), resultBox = $('resultBox');

  // join
  $('joinBtn').addEventListener('click', ()=> {
    const name = $('playerName').value.trim();
    if(!name) { alert('Entre ton pr√©nom'); return; }
    localStorage.setItem('lastPlayerName', name);
    // refresh room state
    room = JSON.parse(localStorage.getItem(key) || '{}');
    // if not started, show wait
    if(!room.started){ joinBox.classList.add('hidden'); waitBox.classList.remove('hidden'); pollRoomStart(); }
    else { joinBox.classList.add('hidden'); startQuiz(name); }
  });

  // poll for start
  let pollInterval = null;
  function pollRoomStart(){
    pollInterval = setInterval(()=>{
      room = JSON.parse(localStorage.getItem(key) || '{}');
      if(room.started){ clearInterval(pollInterval); waitBox.classList.add('hidden'); startQuiz(localStorage.getItem('lastPlayerName') || 'Invit√©'); }
    }, 900);
  }

  // start quiz
  function startQuiz(playerName){
    quizForm.classList.remove('hidden');
    questionsWrap.innerHTML = '';
    // Use room.answers length and questions texts (we display generic prompts)
    const prompts = [
      "Quel est son plat pr√©f√©r√© ?",
      "Quel est son sport pr√©f√©r√© ?",
      "Quel est son animal pr√©f√©r√© ?",
      "Quelle est sa couleur pr√©f√©r√©e ?",
      "Quel est son r√™ve le plus fou ?"
    ];
    room.answers.forEach((_,i)=>{
      const div = document.createElement('div');
      div.className = 'question';
      div.innerHTML = `<label>${prompts[i] || 'Question ' + (i+1)}</label><input type="text" id="ans${i}" placeholder="Ta r√©ponse..." />`;
      questionsWrap.appendChild(div);
    });

    $('submitAnswers').addEventListener('click', ()=> {
      const player = localStorage.getItem('lastPlayerName') || 'Invit√©';
      const answers = room.answers;
      let score = 0; const guestAnswers = [];
      room.answers.forEach((_,i)=>{
        const a = (document.getElementById(`ans${i}`).value || '').trim();
        guestAnswers.push(a);
        if(a && a.toLowerCase() === (answers[i]||'').toLowerCase()) score++;
      });
      // save to room.players
      const res = { name: player, score, answers: guestAnswers, playedAt: new Date().toISOString() };
      room.players = room.players || [];
      room.players.push(res);
      localStorage.setItem(key, JSON.stringify(room));

      // show result + invite create own
      quizForm.classList.add('hidden');
      resultBox.classList.remove('hidden');
      resultBox.innerHTML = `<h3>Bravo ${escapeHtml(player)} üéâ</h3>
         <p>Tu as obtenu <strong>${score}</strong> / ${answers.length}</p>
         <div class="row">
           <button class="btn primary" onclick="location.href='index.html'">Cr√©er mon propre d√©fi</button>
           <button class="btn ghost" onclick="location.href='room.html?uid=${encodeURIComponent(uid)}'">Voir classement de ${escapeHtml(room.host)}</button>
         </div>`;
    });
  }

  // escape helper
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,(m)=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // simple polling to refresh if room is changed while waiting on screen
  setInterval(()=> {
    const r = JSON.parse(localStorage.getItem(key) || '{}');
    if(!r) return;
    // update info if needed
    if(r.started && waitBox && !waitBox.classList.contains('hidden')){
      clearInterval(pollInterval);
      waitBox.classList.add('hidden');
      startQuiz(localStorage.getItem('lastPlayerName')||'Invit√©');
    }
  }, 1200);
</script>
</body>
</html>